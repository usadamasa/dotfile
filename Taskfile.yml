version: '3'

vars:
  DOTFILE_DIR: "{{.USER_WORKING_DIR}}"
  CONFIG_DIR: "$HOME/.config"
  ZSH_CUSTOM: "$HOME/.oh-my-zsh/custom"

tasks:
  default:
    desc: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
    cmds:
      - task: setup

  bootstrap:
    desc: åˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆHomebrewã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‹ã‚‰å®Ÿè¡Œï¼‰
    cmds:
      - echo "ðŸš€ dotfilesåˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
      - task: check-macos
      - task: install-homebrew
      - task: install-go-task-initial
      - echo "âœ… åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã€‚ç¶šã„ã¦é€šå¸¸ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™..."
      - task: setup
      - echo "ðŸŽ‰ å…¨ã¦ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
      - echo "âš ï¸  æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦è¨­å®šã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"

  setup:
    desc: å®Œå…¨ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
    deps:
      - install-homebrew
      - install-core-tools
      - setup-xdg
      - setup-zsh
      - setup-symlinks
      - setup-vim
      - setup-additional-tools

  check-macos:
    desc: macOSç’°å¢ƒã‚’ãƒã‚§ãƒƒã‚¯
    cmds:
      - |
        if [[ "$OSTYPE" != "darwin"* ]]; then
          echo "âŒ ã‚¨ãƒ©ãƒ¼: ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯macOSå°‚ç”¨ã§ã™"
          exit 1
        fi
        echo "âœ… macOSç’°å¢ƒã‚’ç¢ºèªã—ã¾ã—ãŸ"

  install-homebrew:
    desc: Homebrewã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - |
        if ! command -v brew &> /dev/null; then
          echo "ðŸ“¦ Homebrewã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          # Apple Silicon Macã®å ´åˆã¯PATHã«è¿½åŠ 
          if [[ -f "/opt/homebrew/bin/brew" ]]; then
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi
          echo "âœ… Homebrewã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âœ… Homebrew ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™"
        fi
    status:
      - command -v brew

  install-go-task-initial:
    desc: go-taskã®åˆæœŸã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆHomebrewï¼‰
    deps: [install-homebrew]
    cmds:
      - |
        if command -v task &> /dev/null; then
          echo "âœ… go-task ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™"
        else
          echo "ðŸ“¦ go-taskã‚’Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          brew install go-task
          echo "âœ… go-taskã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
        fi

  install-core-tools:
    desc: ä¸»è¦é–‹ç™ºãƒ„ãƒ¼ãƒ«ã‚’Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    deps: [install-homebrew]
    cmds:
      - echo "ðŸ› ï¸ ä¸»è¦é–‹ç™ºãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - |
        if brew install \
          git \
          gh \
          ghq \
          jq \
          direnv \
          peco \
          tig \
          zsh \
          pipx \
          git-now 2>/dev/null; then
          echo "âœ… ä¸»è¦é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âš ï¸  ä¸€éƒ¨ã®ãƒ„ãƒ¼ãƒ«ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆæ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
        fi

  setup-xdg:
    desc: XDG Base Directoryè¨­å®š
    cmds:
      - echo "âš™ï¸ XDG Base Directoryè¨­å®šã‚’é©ç”¨ä¸­..."
      - ln -sfn "{{.DOTFILE_DIR}}/.zshenv" "$HOME/"
      - mkdir -p "{{.CONFIG_DIR}}"
      - mkdir -p "$HOME/.local/share"
      - mkdir -p "$HOME/.cache"
      - echo "âœ… XDG Base Directoryè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ"
    status:
      - test -L "$HOME/.zshenv"
      - test -d "{{.CONFIG_DIR}}"

  setup-zsh:
    desc: Zshã¨oh-my-zshã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    deps: [install-core-tools, setup-xdg]
    cmds:
      - |
        if [ ! -d "$HOME/.oh-my-zsh" ]; then
          echo "ðŸš oh-my-zshã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          RUNZSH=no sh -c "$(curl -fsSL https://install.ohmyz.sh/)"
          echo "âœ… oh-my-zshã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âœ… oh-my-zsh ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™"
        fi
      - task: setup-zsh-plugins
    status:
      - test -d "$HOME/.oh-my-zsh"

  setup-zsh-plugins:
    desc: Zshãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    deps: [setup-zsh]
    cmds:
      - echo "ðŸ”Œ Zshãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - |
        if [ ! -d "{{.ZSH_CUSTOM}}/plugins/zsh-autosuggestions" ]; then
          echo "  ðŸ“¦ zsh-autosuggestionsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          git clone https://github.com/zsh-users/zsh-autosuggestions "{{.ZSH_CUSTOM}}/plugins/zsh-autosuggestions"
        fi
      - |
        if [ ! -d "{{.ZSH_CUSTOM}}/plugins/zsh-syntax-highlighting" ]; then
          echo "  ðŸ“¦ zsh-syntax-highlightingã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "{{.ZSH_CUSTOM}}/plugins/zsh-syntax-highlighting"
        fi
      - echo "âœ… Zshãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
    status:
      - test -d "{{.ZSH_CUSTOM}}/plugins/zsh-autosuggestions"
      - test -d "{{.ZSH_CUSTOM}}/plugins/zsh-syntax-highlighting"

  setup-symlinks:
    desc: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
    deps: [setup-xdg]
    cmds:
      - echo "ðŸ”— è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆä¸­..."
      - rm -rf "{{.CONFIG_DIR}}/zsh"
      - ln -sfn "{{.DOTFILE_DIR}}/config/zsh" "{{.CONFIG_DIR}}/"
      - ln -sfn "{{.DOTFILE_DIR}}/config/git" "{{.CONFIG_DIR}}/"
      - ln -sfn "{{.DOTFILE_DIR}}/config/vim" "{{.CONFIG_DIR}}/"
      - ln -sfn "{{.DOTFILE_DIR}}/config/npm" "{{.CONFIG_DIR}}/"
      - echo "âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ"

  setup-vim:
    desc: Vimç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    deps: [setup-symlinks, install-core-tools]
    cmds:
      - echo "ðŸ“ Vimç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
      - mkdir -p "$HOME/.local/share/vim"
      - mkdir -p "$HOME/.cache/vim/swap"
      - mkdir -p "$HOME/.cache/vim/backup"
      - |
        if ! command -v powerline-shell &> /dev/null; then
          echo "  ðŸ“¦ powerline-shellã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          pipx install powerline-shell
          echo "  âœ… powerline-shellã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "  âœ… powerline-shell ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™"
        fi
      - echo "âœ… Vimç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
    status:
      - test -d "$HOME/.local/share/vim"
      - test -d "$HOME/.cache/vim/swap"
      - test -d "$HOME/.cache/vim/backup"

  setup-additional-tools:
    desc: è¿½åŠ ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    deps: [install-core-tools]
    cmds:
      - echo "ðŸ› ï¸ è¿½åŠ ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - |
        if command -v brew &> /dev/null; then
          echo "  ðŸ“¦ GUIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          brew install --cask font-cica jetbrains-toolbox visual-studio-code 2>/dev/null || echo "  âš ï¸  ä¸€éƒ¨ã®GUIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã›ã‚“ã§ã—ãŸ"
        fi
      - |
        if command -v gh &> /dev/null; then
          if ! gh extension list | grep -q "seachicken/gh-poi"; then
            echo "  ðŸ“¦ gh poiæ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            gh extension install seachicken/gh-poi
          fi
        fi
      - echo "âœ… è¿½åŠ ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

  clean:
    desc: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ³¨æ„ï¼šè¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ï¼‰
    prompt: "æœ¬å½“ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚"
    cmds:
      - rm -f "$HOME/.zshenv"
      - rm -rf "{{.CONFIG_DIR}}/zsh"
      - rm -rf "{{.CONFIG_DIR}}/git"
      - rm -rf "{{.CONFIG_DIR}}/vim"
      - rm -rf "{{.CONFIG_DIR}}/npm"

  status:
    desc: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèª
    cmds:
      - echo "=== ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ³ ==="
      - echo "Homebrew:$(command -v brew >/dev/null && echo 'âœ“' || echo 'âœ—')"
      - echo "go-task:$(command -v task >/dev/null && echo 'âœ“' || echo 'âœ—')"
      - echo "ä¸»è¦ãƒ„ãƒ¼ãƒ«:$(command -v git >/dev/null && command -v gh >/dev/null && command -v jq >/dev/null && echo 'âœ“' || echo 'âœ—')"
      - echo "XDGè¨­å®š:$(test -L "$HOME/.zshenv" && echo 'âœ“' || echo 'âœ—')"
      - echo "oh-my-zsh:$(test -d "$HOME/.oh-my-zsh" && echo 'âœ“' || echo 'âœ—')"
      - echo "zshè¨­å®š:$(test -L "$HOME/.config/zsh" && echo 'âœ“' || echo 'âœ—')"
      - echo "gitè¨­å®š:$(test -L "$HOME/.config/git" && echo 'âœ“' || echo 'âœ—')"
      - echo "vimè¨­å®š:$(test -L "$HOME/.config/vim" && echo 'âœ“' || echo 'âœ—')"
      - echo "npmè¨­å®š:$(test -L "$HOME/.config/npm" && echo 'âœ“' || echo 'âœ—')"
